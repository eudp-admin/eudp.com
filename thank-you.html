<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">ምዝገባዎ ተሳክቷል - ኢአልፓ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Abyssinica+SIL&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #0D2D4E;
            --color-secondary: #2E8B57;
            --color-text: #343a40;
            --color-background-soft: #f8f9fa;
            --radius-lg: 16px;
            --shadow-md: 0 4px 15px rgba(0, 0, 0, 0.08);
            --font-amharic: 'Abyssinica SIL', serif;
            --font-english: 'Roboto', 'Times New Roman', serif;
        }
        html[lang="am"] body { font-family: var(--font-amharic); }
        html[lang="en"] body { font-family: var(--font-english); }
        
        body { background-color: var(--color-background-soft); color: var(--color-text); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; box-sizing: border-box; }
        .container { max-width: 900px; width: 100%; background: white; padding: 2rem 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); text-align: center; border-top: 5px solid var(--color-secondary); }
        .icon-success { font-size: 3rem; color: var(--color-secondary); margin-bottom: 1rem; }
        h1 { color: var(--color-primary); font-size: 2rem; margin-bottom: 0.5rem; }
        .intro-text { font-size: 1.1rem; line-height: 1.7; margin-bottom: 2rem; max-width: 700px; margin-left: auto; margin-right: auto; }
        .actions { margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .btn { padding: 0.8rem 1.8rem; border: none; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s ease; }
        .btn:disabled { background-color: #aaa; cursor: not-allowed; }
        .btn .spinner { display: none; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        .btn.loading .spinner { display: inline-block; }
        .btn.loading .fas { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-secondary { background-color: var(--color-secondary); color: white; }
        #no-data-message { background-color: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; border: 1px solid #ffeeba; }
        
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .container { padding: 1.5rem 1rem; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <i class="fas fa-check-circle icon-success"></i>
        <h1 data-lang-key="successTitle">ምዝገባዎ ተሳክቷል!</h1>
        <p class="intro-text" data-lang-key="introText">የአባልነት ማረጋገጫ ሰነድዎን ለማውረድ "ሰነዱን በPDF ያውርዱ" የሚለውን ቁልፍ ይጫኑ።</p>

        <div id="no-data-message" style="display: none;">
             <p data-lang-key="noDataMessage">የማረጋገጫ ሰነድዎን ለማሳየት የሚያስችል መረጃ አልተገኘም። እባክዎ ወደ መነሻ ገጽ በመመለስ ቅጹን እንደገና ይሙሉ!</p>
        </div>

        <div class="actions">
            <a href="index.html" class="btn btn-primary"><i class="fas fa-home"></i> <span data-lang-key="backToHomeBtn">ወደ መነሻ ገጽ ይመለሱ</span></a>
            <button id="download-pdf-btn" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-download"></i>
                <span class="spinner"></span>
                <span class="btn-text" data-lang-key="downloadPdfBtn">ሰነዱን በPDF ያውርዱ</span>
            </button>
        </div>
    </div>

    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- ይህንን መስመር መጨመርህን እንዳትረሳ! በደረጃ 2 ያዘጋጀኸው ፋይል ነው። -->
    <script src="assets/AbyssinicaSIL-Regular-normal.js"></script>

    <script>
        // --- IMAGE DATA (Base64) ---
        // TODO: Replace these with your actual Base64 image data
        const logoBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0CAYAAADL1t+KAAA...'; 
        const signatureBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcoAAAIhCAYAAADO9/oAAA...';
        const stampBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATYAAAFBCAYAAAD9m4PQAAAA...'; 
        
        // --- LANGUAGE AND TRANSLATION SCRIPT ---
        const langStrings = {
            am: {
                pageTitle: 'ምዝገባዎ ተሳክቷል - ኢአልፓ',
                successTitle: 'ምዝገባዎ ተሳክቷል!',
                introText: 'የአባልነት ማረጋገጫ ሰነድዎን ለማውረድ "ሰነዱን በPDF ያውርዱ" የሚለውን ቁልፍ ይጫኑ።',
                certTitle: 'የአባልነት ምዝገባ ማረጋገጫ',
                certSubtitle: 'የኢትዮጵያ አንድነት እና ልማት ፓርቲ (ኢአልፓ)',
                certBodyIntro: 'ይህ ሰነድ ክቡር/ት ',
                certBodyOutro: ' የኢትዮጵያ አንድነት እና ልማት ፓርቲ (ኢአልፓ) ሙሉ አባል መሆናቸውን ያረጋግጣል።',
                memberIdLabel: 'የአባልነት መለያ ቁጥር፡',
                regDateLabel: 'የተመዘገቡበት ቀን፡',
                tableHeaderDetail: 'ዝርዝር',
                tableHeaderInfo: 'መረጃ',
                signatureName: 'አቶ ሙሉጌታ ከበደ',
                signatureTitle: 'የፓርቲው ሊቀመንበር',
                noDataMessage: 'የማረጋገጫ ሰነድዎን ለማሳየት የሚያስችል መረጃ አልተገኘም። እባክዎ ወደ መነሻ ገጽ በመመለስ ቅጹን እንደገና ይሙሉ!',
                backToHomeBtn: 'ወደ መነሻ ገጽ ይመለሱ',
                downloadPdfBtn: 'ሰነዱን በPDF ያውርዱ',
                downloadingPdfBtn: 'በማዘጋጀት ላይ...',
                labels: { fullName: 'ሙሉ ስም', age: 'እድሜ', gender: 'ፆታ', phone: 'ስልክ ቁጥር', email: 'ኢሜይል', education: 'የትምህርት ደረጃ', region: 'ክልል', zone: 'ዞን', city: 'ከተማ', woreda: 'ወረዳ', kebele: 'ቀበሌ' }
            },
            en: {
                pageTitle: 'Registration Successful - EUDP',
                successTitle: 'Registration Successful!',
                introText: 'To download your membership certificate, click the "Download Certificate as PDF" button.',
                certTitle: 'Membership Registration Certificate',
                certSubtitle: 'Ethiopian Unity and Development Party (EUDP)',
                certBodyIntro: 'This document certifies that ',
                certBodyOutro: ' is a full member of the Ethiopian Unity and Development Party (EUDP).',
                memberIdLabel: 'Membership ID:',
                regDateLabel: 'Registration Date:',
                tableHeaderDetail: 'Detail',
                tableHeaderInfo: 'Information',
                signatureName: 'Mr. Mulugeta Kebede',
                signatureTitle: 'Party Chairman',
                noDataMessage: 'No data found to display your certificate. Please return to the homepage and fill out the form again.',
                backToHomeBtn: 'Back to Homepage',
                downloadPdfBtn: 'Download Certificate as PDF',
                downloadingPdfBtn: 'Generating...',
                labels: { fullName: 'Full Name', age: 'Age', gender: 'Gender', phone: 'Phone Number', email: 'Email', education: 'Education Level', region: 'Region', zone: 'Zone', city: 'City', woreda: 'Woreda', kebele: 'Kebele' }
            }
        };

        function getLangFromURL() {
            const params = new URLSearchParams(window.location.search);
            const lang = params.get('lang');
            return (lang === 'en' || lang === 'am') ? lang : 'am';
        }

        function setLanguage(lang) {
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (langStrings[lang][key]) {
                    el.innerHTML = langStrings[lang][key];
                }
            });
        }
        
        // --- MAIN LOGIC SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentLang = getLangFromURL();
            setLanguage(currentLang);

            const registrationDataString = localStorage.getItem('registrationData');
            const downloadBtn = document.getElementById('download-pdf-btn');
            const noDataMessage = document.getElementById('no-data-message');

            if (!registrationDataString) {
                noDataMessage.style.display = 'block';
                return;
            }
            
            downloadBtn.style.display = 'inline-flex';

            // Programmatic PDF Download Functionality (No html2canvas)
            downloadBtn.addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const btnTextSpan = downloadBtn.querySelector('.btn-text');
                
                downloadBtn.disabled = true;
                downloadBtn.classList.add('loading');
                btnTextSpan.textContent = langStrings[currentLang].downloadingPdfBtn;

                try {
                    const data = JSON.parse(registrationDataString || '{}');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Add and set the font based on language
                    const docFont = currentLang === 'am' ? 'AbyssinicaSIL-Regular' : 'Times-Roman';
                    if (currentLang === 'am') {
                        pdf.addFileToVFS('AbyssinicaSIL-Regular-normal.ttf', fontData);
                        pdf.addFont('AbyssinicaSIL-Regular-normal.ttf', 'AbyssinicaSIL-Regular', 'normal');
                    }
                    pdf.setFont(docFont);
                    
                    const memberId = `EUDP-${Math.floor(100000 + Math.random() * 900000)}`;
                    const regDateOptions = (currentLang === 'am') 
                        ? { year: 'numeric', month: 'long', day: 'numeric', calendar: 'ethiopic' }
                        : { year: 'numeric', month: 'long', day: 'numeric' };
                    const registrationDate = new Date().toLocaleDateString(`${currentLang}-ET`, regDateOptions);
                    
                    const lang = langStrings[currentLang];
                    const margin = 15;
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    let y = 20;

                    // Header
                    pdf.addImage(logoBase64, 'PNG', margin, y, 20, 20);
                    pdf.setFont(docFont, 'bold');
                    pdf.setFontSize(16);
                    pdf.setTextColor('#0D2D4E');
                    pdf.text(lang.certTitle, margin + 25, y + 8);
                    pdf.setFont(docFont, 'normal');
                    pdf.setFontSize(12);
                    pdf.setTextColor('#343a40');
                    pdf.text(lang.certSubtitle, margin + 25, y + 15);
                    y += 30;

                    // Divider
                    pdf.setLineWidth(0.5);
                    pdf.line(margin, y, pageWidth - margin, y);
                    y += 10;
                    
                    // Intro Text
                    pdf.setFontSize(11);
                    const introLines = pdf.splitTextToSize(
                        `${lang.certBodyIntro} ${data.fullName || 'N/A'} ${lang.certBodyOutro}`,
                        pageWidth - (2 * margin)
                    );
                    pdf.text(introLines, margin, y);
                    y += (introLines.length * 6) + 2;

                    pdf.text(`${lang.memberIdLabel} ${memberId} | ${lang.regDateLabel} ${registrationDate}`, margin, y);
                    y += 15;

                    // Table using jspdf-autotable logic (manual implementation)
                    const tableData = [];
                    const labels = lang.labels;
                    for (const key in labels) {
                        if (data.hasOwnProperty(key)) {
                            tableData.push([labels[key], data[key] || '-']);
                        }
                    }

                    const startY = y;
                    const rowHeight = 10;
                    const col1X = margin;
                    const col2X = margin + 60;

                    pdf.setFont(docFont, 'bold');
                    pdf.setFontSize(12);
                    pdf.setFillColor(13, 45, 78); // --color-primary
                    pdf.setTextColor(255, 255, 255);
                    pdf.rect(margin, y, pageWidth - (2 * margin), rowHeight, 'F');
                    pdf.text(lang.tableHeaderDetail, col1X + 2, y + 7);
                    pdf.text(lang.tableHeaderInfo, col2X + 2, y + 7);
                    y += rowHeight;
                    
                    pdf.setFont(docFont, 'normal');
                    pdf.setFontSize(11);
                    pdf.setTextColor(52, 58, 64); // --color-text

                    tableData.forEach(row => {
                        pdf.setDrawColor(204, 204, 204);
                        pdf.rect(margin, y - rowHeight, pageWidth - (2 * margin), rowHeight);
                        pdf.text(row[0], col1X + 2, y - 3);
                        pdf.text(row[1], col2X + 2, y - 3);
                        y += rowHeight;
                    });
                     pdf.rect(margin, y - rowHeight, pageWidth - (2 * margin), rowHeight);

                    // Signatures
                    y += 25;
                    const sigBlockX = margin + 10;
                    const stampBlockX = pageWidth - margin - 50;
                    
                    pdf.addImage(signatureBase64, 'PNG', sigBlockX, y, 60, 30);
                    pdf.setLineWidth(0.3);
                    pdf.line(sigBlockX, y + 35, sigBlockX + 60, y + 35);
                    pdf.setFontSize(10);
                    pdf.text(lang.signatureName, sigBlockX + 30, y + 40, { align: 'center' });
                    pdf.text(lang.signatureTitle, sigBlockX + 30, y + 45, { align: 'center' });

                    pdf.addImage(stampBase64, 'PNG', stampBlockX, y, 40, 40);

                    // Footer
                    const footerY = pdf.internal.pageSize.getHeight() - 15;
                    pdf.setLineWidth(0.3);
                    pdf.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                    pdf.setFontSize(9);
                    pdf.setTextColor(68, 68, 68);
                    pdf.text(`+251 911 223 344  |  info@eudp.org.et`, pageWidth / 2, footerY, { align: 'center' });
                    
                    pdf.save(`${data.fullName || 'member'}-EUDP-Certificate.pdf`);

                } catch (error) {
                    console.error("PDF generation failed:", error);
                    alert("Sorry, the PDF could not be generated. Please try again.");
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.classList.remove('loading');
                    btnTextSpan.textContent = langStrings[currentLang].downloadPdfBtn;
                    localStorage.removeItem('registrationData');
                }
            });
            
        });
    </script>
</body>
</html>
